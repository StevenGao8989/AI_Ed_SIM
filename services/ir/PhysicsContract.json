{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PhysicsContract",
  "description": "物理合同：定义物理世界的几何、物性、约束和验收标准",
  "type": "object",
  "required": ["world", "surfaces", "bodies", "tolerances"],
  "properties": {
    "world": {
      "type": "object",
      "description": "世界坐标系和全局常数",
      "required": ["coord", "gravity"],
      "properties": {
        "coord": { 
          "enum": ["xy_y_up", "xy_y_down"],
          "description": "坐标系约定：y轴向上或向下"
        },
        "gravity": { 
          "type": "array", 
          "items": { "type": "number" }, 
          "minItems": 2, 
          "maxItems": 2,
          "description": "重力矢量 [gx, gy]"
        },
        "constants": { 
          "type": "object", 
          "additionalProperties": { "type": "number" },
          "description": "物理常数库"
        }
      }
    },
    "surfaces": {
      "type": "array",
      "description": "接触面定义",
      "items": {
        "type": "object",
        "required": ["id", "type", "point", "normal"],
        "properties": {
          "id": { 
            "type": "string",
            "description": "面的唯一标识"
          },
          "type": { 
            "enum": ["plane"],
            "description": "面类型（目前只支持平面）"
          },
          "point": { 
            "type": "array", 
            "items": { "type": "number" }, 
            "minItems": 2, 
            "maxItems": 2,
            "description": "面上一点 [x, y]"
          },
          "normal": { 
            "type": "array", 
            "items": { "type": "number" }, 
            "minItems": 2, 
            "maxItems": 2,
            "description": "法向量 [nx, ny]（应为单位向量）"
          },
          "mu_s": { 
            "type": "number",
            "minimum": 0,
            "description": "静摩擦系数"
          },
          "mu_k": { 
            "type": "number",
            "minimum": 0,
            "description": "动摩擦系数"
          },
          "restitution": { 
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "恢复系数 (0=完全非弹性, 1=完全弹性)"
          },
          "material": {
            "type": "object",
            "description": "表面材料属性",
            "properties": {
              "restitution": { "type": "number", "minimum": 0, "maximum": 1 },
              "mu_s": { "type": "number", "minimum": 0 },
              "mu_k": { "type": "number", "minimum": 0 }
            }
          }
        }
      }
    },
    "bodies": {
      "type": "array",
      "description": "刚体定义",
      "items": {
        "type": "object",
        "required": ["id", "kind", "shape", "mass"],
        "properties": {
          "id": { 
            "type": "string",
            "description": "刚体唯一标识"
          },
          "kind": {
            "enum": ["ball", "cart", "block", "board", "point", "compound"],
            "description": "物体类型"
          },
          "shape": { 
            "enum": ["circle", "box", "point"],
            "description": "几何形状"
          },
          "mass": { 
            "type": "number", 
            "exclusiveMinimum": 0,
            "description": "质量 (kg)"
          },
          "inertia": {
            "oneOf": [
              { "type": "number" },
              { "type": "array", "items": { "type": "number" }, "minItems": 3, "maxItems": 3 }
            ],
            "description": "转动惯量 (kg⋅m²)"
          },
          "size": { 
            "type": "array", 
            "items": { "type": "number", "minimum": 0 },
            "description": "尺寸参数: circle:[r] | box:[w,h]"
          },
          "init": {
            "type": "object",
            "description": "初始状态",
            "properties": {
              "x": { "type": "number", "description": "初始x坐标" },
              "y": { "type": "number", "description": "初始y坐标" },
              "theta": { "type": "number", "description": "初始角度" },
              "vx": { "type": "number", "description": "初始x速度" },
              "vy": { "type": "number", "description": "初始y速度" },
              "omega": { "type": "number", "description": "初始角速度" }
            }
          },
          "material": {
            "type": "object",
            "description": "材料属性",
            "properties": {
              "restitution": { "type": "number", "minimum": 0, "maximum": 1 },
              "mu_s": { "type": "number", "minimum": 0 },
              "mu_k": { "type": "number", "minimum": 0 }
            }
          },
          "contacts": { 
            "type": "array", 
            "items": { "type": "string" },
            "description": "可接触的面ID列表"
          }
        }
      }
    },
    "phases": {
      "type": "array",
      "description": "物理阶段定义",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "name": { "type": "string" },
          "description": { "type": "string" },
          "startCondition": { "type": "object" },
          "endCondition": { "type": "object" },
          "dominantForces": { "type": "array", "items": { "type": "string" } }
        }
      }
    },
    "expected_events": {
      "type": "array",
      "description": "预期事件列表",
      "items": {
        "type": "object",
        "required": ["name", "type"],
        "properties": {
          "name": { "type": "string", "description": "事件名称" },
          "type": { 
            "enum": ["contact", "separation", "velocity_zero", "position_extreme"],
            "description": "事件类型"
          },
          "body": { "type": "string", "description": "涉及的刚体ID" },
          "surface": { "type": "string", "description": "涉及的面ID" },
          "timeWindow": { 
            "type": "array", 
            "items": { "type": "number" }, 
            "minItems": 2, 
            "maxItems": 2,
            "description": "预期时间窗口 [tmin, tmax]"
          },
          "condition": { "type": "object", "description": "事件触发条件" }
        }
      }
    },
    "acceptance_tests": {
      "type": "array",
      "description": "验收测试断言",
      "items": {
        "oneOf": [
          {
            "type": "object",
            "required": ["kind", "name", "of"],
            "properties": {
              "kind": { "const": "event_time" },
              "name": { "type": "string" },
              "of": { "type": "string" },
              "window": { 
                "type": "array", 
                "items": { "type": "number" }, 
                "minItems": 2, 
                "maxItems": 2 
              }
            }
          },
          {
            "type": "object",
            "required": ["kind", "name", "of", "pattern"],
            "properties": {
              "kind": { "const": "shape" },
              "name": { "type": "string" },
              "of": { "type": "string" },
              "pattern": { "enum": ["single_peak", "parabola", "monotonic"] },
              "tol": { "type": "number", "minimum": 0 }
            }
          },
          {
            "type": "object",
            "required": ["kind", "name", "quantity"],
            "properties": {
              "kind": { "const": "conservation" },
              "name": { "type": "string" },
              "quantity": { "enum": ["energy", "momentum", "angular_momentum"] },
              "drift": { "type": "number", "minimum": 0 }
            }
          },
          {
            "type": "object",
            "required": ["kind", "name", "expr"],
            "properties": {
              "kind": { "const": "ratio" },
              "name": { "type": "string" },
              "expr": { "type": "string" },
              "tol": { "type": "number", "minimum": 0 }
            }
          }
        ]
      }
    },
    "tolerances": {
      "type": "object",
      "description": "数值容差配置",
      "properties": {
        "r2_min": { 
          "type": "number", 
          "minimum": 0, 
          "maximum": 1,
          "description": "最小R²拟合度"
        },
        "rel_err": { 
          "type": "number", 
          "minimum": 0,
          "description": "相对误差阈值"
        },
        "event_time_sec": { 
          "type": "number", 
          "minimum": 0,
          "description": "事件时间容差 (秒)"
        },
        "energy_drift_rel": { 
          "type": "number", 
          "minimum": 0,
          "description": "能量漂移相对阈值"
        },
        "v_eps": { 
          "type": "number", 
          "minimum": 0,
          "description": "速度阈值（摩擦滞回）"
        }
      }
    }
  },
  "additionalProperties": false
}
