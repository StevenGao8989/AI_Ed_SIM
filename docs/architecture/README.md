# ChatTutor AI 物理仿真平台 - 项目架构

## 🏗️ 架构概览

ChatTutor AI 物理仿真平台采用现代化的分层架构设计，结合 AI 增强技术和传统物理仿真方法，为用户提供智能化的物理题目解析和动画生成服务。

## 🎯 设计理念

### 1. 分层架构
- **表现层**: 用户界面和交互
- **业务逻辑层**: 核心算法和业务规则
- **数据访问层**: 数据存储和检索
- **基础设施层**: 外部服务和工具

### 2. 模块化设计
- 每个功能模块独立开发和测试
- 清晰的接口定义和依赖关系
- 支持插件式扩展和功能组合

### 3. AI 优先策略
- AI 增强作为核心功能
- 智能回退到传统方法
- 持续学习和优化

## 🏛️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ChatTutor 平台架构                        │
├─────────────────────────────────────────────────────────────┤
│  🎨 前端层 (Frontend Layer)                                │
│  ├── Next.js + React + TypeScript                          │
│  ├── TailwindCSS + Three.js                               │
│  ├── 用户界面组件 (UI Components)                          │
│  └── 客户端库 (Client Libraries)                           │
├─────────────────────────────────────────────────────────────┤
│  🔧 业务逻辑层 (Business Logic Layer)                      │
│  ├── AI 增强解析器 (AI-Enhanced Parser)                    │
│  ├── DSL 生成器 (DSL Generator)                            │
│  ├── 仿真引擎 (Simulation Engine)                          │
│  └── 渲染器 (Renderer)                                     │
├─────────────────────────────────────────────────────────────┤
│  🗄️ 数据层 (Data Layer)                                   │
│  ├── Supabase (Auth + PostgreSQL)                          │
│  ├── Redis (缓存)                                          │
│  ├── 文件存储 (File Storage)                               │
│  └── 配置管理 (Configuration)                              │
├─────────────────────────────────────────────────────────────┤
│  🌐 外部服务层 (External Services Layer)                   │
│  ├── DeepSeek R3 API                                      │
│  ├── OpenAI API                                           │
│  ├── 本地 AI 模型                                         │
│  └── 第三方服务                                           │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 核心流程架构

### 1. 物理题目解析流程
```
用户输入 → AI 增强解析 → 结构化数据 → 验证和优化 → 输出结果
    ↓           ↓           ↓           ↓         ↓
  自然语言    DeepSeek    参数/单位    质量检查   最终结果
  题目文本    R3 API     主题分类     置信度评估   JSON格式
```

### 2. 仿真生成流程
```
解析结果 → DSL 生成 → IR 转换 → 仿真计算 → 动画渲染 → 结果输出
    ↓         ↓         ↓         ↓         ↓         ↓
  结构化数据  YAML格式   IR格式    数值计算   可视化    动画文件
  物理参数   系统配置   中间表示   事件检测   3D渲染   导出格式
```

### 3. IR 层处理流程 (新增)
```
DSL 输入 → 智能模块检测 → 原子模块匹配 → IR 生成 → 验证优化 → 输出 IR
    ↓           ↓             ↓           ↓         ↓         ↓
  YAML格式   语义分析      模块库匹配    JSON格式   质量检查   最终IR
  系统配置   智能评分      动态阈值     中间表示   错误恢复   仿真就绪
```

## 🧠 IR 层架构详解

### 1. 智能模块检测系统
```
输入分析 → 语义评分 → 动态阈值 → 模块匹配 → 结果输出
    ↓         ↓         ↓         ↓         ↓
  问题文本   多维度    自适应    原子模块   匹配列表
  参数符号   评分算法   阈值调整   库查询    置信度
```

**核心特性**:
- **多维度评分**: 参数匹配(30%) + 系统类型(25%) + 语义分析(25%) + 物理概念(20%)
- **动态阈值**: 根据模块类型自动调整匹配阈值
- **同义词映射**: 支持中文物理术语的同义词识别
- **类型映射**: 智能映射不同物理域之间的关联关系

### 2. 错误处理和恢复机制
```
错误检测 → 错误分类 → 恢复策略 → 回退处理 → 结果输出
    ↓         ↓         ↓         ↓         ↓
  异常捕获   严重程度   自动修复   默认配置   最终结果
  日志记录   错误类型   智能回退   质量保证   状态报告
```

**核心特性**:
- **分层错误处理**: 元数据、系统配置、仿真配置、输出配置独立处理
- **智能回退**: 自动生成默认配置确保系统可用性
- **详细日志**: 完整的错误信息和恢复过程记录
- **质量保证**: 即使部分失败也能保证基本功能

### 3. 性能监控和缓存系统
```
请求处理 → 缓存检查 → 性能监控 → 结果缓存 → 指标更新
    ↓         ↓         ↓         ↓         ↓
  转换请求   命中检查   时间统计   结果存储   性能指标
  参数解析   缓存查询   内存监控   自动清理   实时报告
```

**核心特性**:
- **智能缓存**: 转换结果、模块检测、验证结果三级缓存
- **性能指标**: 转换时间、缓存命中率、错误率、内存使用
- **自动管理**: 缓存大小限制、LRU清理、内存优化
- **实时监控**: 可查询的性能指标和系统状态

### 4. 数值计算优化
```
复杂度分析 → 求解器选择 → 精度控制 → 收敛准则 → 性能评估
    ↓           ↓           ↓         ↓         ↓
  系统评估     自适应      动态调整   智能设置   效果监控
  方程分析     最优选择    精度平衡   收敛保证   性能优化
```

**核心特性**:
- **自适应求解器**: 根据系统复杂度自动选择最优求解器
- **动态精度控制**: 根据计算需求调整数值精度
- **智能收敛准则**: 基于系统特性设置收敛参数
- **性能评估**: 实时监控计算性能和数值稳定性

## 📁 目录结构架构

```
AI_Ed_SIM/
├── 📚 docs/                    # 文档中心
│   ├── architecture/           # 架构文档
│   ├── ai-parsing/            # AI 功能文档
│   ├── testing/               # 测试文档
│   └── development/           # 开发指南
├── 🎨 frontend/               # 前端应用
│   ├── lib/                   # 核心库
│   │   ├── physicsParser.ts   # 物理解析器
│   │   ├── aiClient.ts        # AI 客户端
│   │   └── DeepSeekClient.ts  # DeepSeek 客户端
│   ├── components/            # UI 组件
│   ├── pages/                 # 页面路由
│   └── styles/                # 样式文件
├── ⚙️ services/               # 后端服务
│   ├── ai_parsing/            # AI 解析服务
│   │   ├── PhysicsAIParserAICaller.ts  # AI 增强解析器
│   │   ├── AtomicModules.ts            # 原子模块库
│   │   └── PhysicsAIParser.ts          # 基础解析器
│   ├── dsl/                   # DSL 处理
│   │   └── PhysicsDslGenerator.ts      # DSL 生成器
│   ├── ir/                    # 中间表示层 (IR)
│   │   ├── IRConverter.ts              # IR 转换器
│   │   ├── IRValidator.ts              # IR 验证器
│   │   ├── PhysicsIR.ts                # IR 数据结构
│   │   └── PhysicsSchema.json          # IR 模式定义
│   ├── simulation/            # 仿真引擎
│   ├── rendering/             # 渲染服务
│   └── testing/               # 测试文件
├── 🗄️ db/                    # 数据库
│   ├── tenants.sql            # 租户表
│   ├── profiles.sql           # 用户表
│   ├── subscriptions.sql      # 订阅表
│   └── dsl_records.sql        # DSL 记录表
└── 🐳 docker/                 # 容器化配置
```

## 🔌 接口设计

### 1. API 接口规范
- **RESTful 设计**: 遵循 REST 架构原则
- **GraphQL 支持**: 灵活的数据查询
- **WebSocket**: 实时通信和状态更新
- **版本控制**: API 版本管理和兼容性

### 2. 数据接口
- **标准化格式**: JSON Schema 验证
- **类型安全**: TypeScript 类型定义
- **错误处理**: 统一的错误码和消息
- **性能优化**: 缓存和分页支持

### 3. IR 层接口 (新增)
- **智能模块检测**: 语义分析和评分机制
- **原子模块匹配**: 动态阈值和类型映射
- **错误恢复**: 回退机制和自动修复
- **性能监控**: 实时指标和缓存管理
- **验证优化**: 多维度质量检查

## 🚀 技术栈选择

### 前端技术
- **框架**: Next.js 13+ (App Router)
- **UI 库**: React 18+ + TypeScript
- **样式**: TailwindCSS + CSS Modules
- **3D 渲染**: Three.js + React Three Fiber
- **状态管理**: Zustand + React Query

### 后端技术
- **运行时**: Node.js 18+ + TypeScript
- **数据库**: Supabase (PostgreSQL)
- **缓存**: Redis + Supabase Edge Cache
- **认证**: Supabase Auth + JWT
- **部署**: Vercel + Supabase

### AI 技术
- **大语言模型**: DeepSeek R3, OpenAI GPT-4
- **向量数据库**: Supabase Vector
- **模型管理**: LangChain + 自定义链
- **提示工程**: 结构化提示词设计

## 🔒 安全架构

### 1. 认证与授权
- **多因素认证**: 邮箱 + 密码 + OTP
- **角色权限**: 学生、教师、管理员
- **租户隔离**: 多租户数据安全
- **API 安全**: 速率限制和访问控制

### 2. 数据安全
- **加密存储**: 敏感数据加密
- **传输安全**: HTTPS + WSS
- **隐私保护**: GDPR 合规
- **审计日志**: 操作记录和追踪

## 📈 性能架构

### 1. 前端性能
- **代码分割**: 按需加载和懒加载
- **缓存策略**: 静态资源缓存
- **CDN 加速**: 全球内容分发
- **PWA 支持**: 离线访问能力

### 2. 后端性能
- **数据库优化**: 索引和查询优化
- **缓存层**: 多层缓存策略
- **异步处理**: 队列和后台任务
- **负载均衡**: 水平扩展支持

### 3. IR 层性能优化 (新增)
- **智能缓存**: 转换结果缓存和模块检测缓存
- **性能监控**: 实时转换时间、缓存命中率、错误率统计
- **并行处理**: 多模块并行转换支持
- **内存管理**: 自动缓存清理和大小限制
- **数值优化**: 自适应求解器选择和精度控制

## 🔄 部署架构

### 1. 环境管理
- **开发环境**: 本地开发 + 测试
- **测试环境**: 集成测试 + 验收测试
- **预生产环境**: 性能测试 + 压力测试
- **生产环境**: 高可用 + 监控

### 2. 部署策略
- **CI/CD 流水线**: 自动化构建和部署
- **蓝绿部署**: 零停机更新
- **回滚机制**: 快速故障恢复
- **监控告警**: 实时状态监控

## 🎯 扩展性设计

### 1. 水平扩展
- **微服务架构**: 服务拆分和独立部署
- **容器化**: Docker + Kubernetes
- **负载均衡**: 多实例负载分发
- **数据库分片**: 数据水平分割

### 2. 功能扩展
- **插件系统**: 模块化功能扩展
- **API 网关**: 统一接口管理
- **事件驱动**: 异步消息处理
- **配置中心**: 动态配置管理

## 🔮 未来架构规划

### 短期目标 (3-6个月)
- [x] 完善 IR 层架构和智能模块检测
- [x] 实现错误处理和恢复机制
- [x] 添加性能监控和缓存系统
- [ ] 完善微服务架构
- [ ] 实现分布式缓存
- [ ] 添加消息队列
- [ ] 优化数据库性能

### 中期目标 (6-12个月)
- [ ] 实现并行处理支持
- [ ] 添加可视化调试工具
- [ ] 实现边缘计算
- [ ] 添加机器学习管道
- [ ] 支持多云部署
- [ ] 实现自动扩缩容

### 长期目标 (1-2年)
- [ ] 构建 AI 原生架构
- [ ] 实现联邦学习
- [ ] 支持量子计算
- [ ] 实现自适应架构

---

**架构版本**: 1.1.0  
**最后更新**: 2024年12月  
**维护者**: ChatTutor AI 开发团队

## 📋 更新日志

### v1.1.0 (2024年12月) - IR 层架构增强
- ✅ 新增 IR 层架构详解
- ✅ 实现智能模块检测系统
- ✅ 完善错误处理和恢复机制
- ✅ 添加性能监控和缓存系统
- ✅ 优化数值计算和求解器选择
- ✅ 更新目录结构和服务架构
- ✅ 增强接口设计和性能优化

### v1.0.0 (2024年12月) - 初始架构
- ✅ 基础分层架构设计
- ✅ 核心流程定义
- ✅ 技术栈选择
- ✅ 安全架构设计
- ✅ 部署架构规划
